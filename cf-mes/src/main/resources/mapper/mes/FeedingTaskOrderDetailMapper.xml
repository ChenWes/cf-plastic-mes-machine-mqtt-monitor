<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cf.mes.mapper.FeedingTaskOrderDetailMapper">

    <resultMap type="FeedingTaskOrderDetail" id="FeedingTaskOrderDetailResult">
        <result property="detailId"    column="detail_id"    />
        <result property="taskId"    column="task_id"    />
        <result property="materialId"    column="material_id"    />
        <result property="materialCode"    column="material_code"    />
        <result property="materialBatchNo"    column="material_batch_no"    />
        <result property="taskStatus"    column="task_status"    />
        <result property="supportMachineId"    column="support_machine_id"    />
        <result property="supportMachineCode"    column="support_machine_code"    />
        <result property="feedingTime"    column="feeding_time"    />
        <result property="feedingWeight"    column="feeding_weight"    />
        <result property="feedingSeqNo"    column="feeding_seq_no"    />
        <result property="remark"    column="remark"    />
        <result property="employeeId"    column="employee_id"    />
        <result property="employeeCode"    column="employee_code"    />
        <result property="latestFlag"    column="latest_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="getFeedingTaskOrderDetailVo">
        select detail_id, task_id, material_id, material_code, material_batch_no, task_status, support_machine_id, support_machine_code, feeding_time, feeding_weight, feeding_seq_no, remark, employee_id, employee_code, latest_flag, create_by, create_time, update_by, update_time from feeding_task_order_detail
    </sql>

    <select id="getFeedingTaskOrderDetailList" parameterType="FeedingTaskOrderDetail" resultMap="FeedingTaskOrderDetailResult">
        <include refid="getFeedingTaskOrderDetailVo"/>
        <where>
            <if test="taskId != null "> and task_id = #{taskId}</if>
            <if test="materialId != null "> and material_id = #{materialId}</if>
            <if test="materialCode != null  and materialCode != ''"> and material_code = #{materialCode}</if>
            <if test="materialBatchNo != null  and materialBatchNo != ''"> and material_batch_no = #{materialBatchNo}</if>
            <if test="taskStatus != null  and taskStatus != ''"> and task_status = #{taskStatus}</if>
            <if test="supportMachineId != null "> and support_machine_id = #{supportMachineId}</if>
            <if test="supportMachineCode != null  and supportMachineCode != ''"> and support_machine_code = #{supportMachineCode}</if>
            <if test="feedingTime != null "> and feeding_time = #{feedingTime}</if>
            <if test="feedingWeight != null "> and feeding_weight = #{feedingWeight}</if>
            <if test="feedingSeqNo != null "> and feeding_seq_no = #{feedingSeqNo}</if>
            <if test="employeeId != null "> and employee_id = #{employeeId}</if>
            <if test="employeeCode != null  and employeeCode != ''"> and employee_code = #{employeeCode}</if>
            <if test="latestFlag != null "> and latest_flag = #{latestFlag}</if>
        </where>
    </select>

    <select id="getFeedingTaskOrderDetailListByDetailIds" resultMap="FeedingTaskOrderDetailResult">
        <include refid="getFeedingTaskOrderDetailVo"/>
        where detail_id in
        <foreach item="detailId" collection="list" open="(" separator="," close=")">
            #{detailId}
        </foreach>
    </select>

    <select id="getFeedingTaskOrderDetailByDetailId" parameterType="Long" resultMap="FeedingTaskOrderDetailResult">
        <include refid="getFeedingTaskOrderDetailVo"/>
        where detail_id = #{detailId}
    </select>

    <insert id="insertFeedingTaskOrderDetail" parameterType="FeedingTaskOrderDetail" useGeneratedKeys="true" keyProperty="detailId">
        insert into feeding_task_order_detail
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="taskId != null">task_id,</if>
            <if test="materialId != null">material_id,</if>
            <if test="materialCode != null and materialCode != ''">material_code,</if>
            <if test="materialBatchNo != null and materialBatchNo != ''">material_batch_no,</if>
            <if test="taskStatus != null">task_status,</if>
            <if test="supportMachineId != null">support_machine_id,</if>
            <if test="supportMachineCode != null and supportMachineCode != ''">support_machine_code,</if>
            <if test="feedingTime != null">feeding_time,</if>
            <if test="feedingWeight != null">feeding_weight,</if>
            <if test="feedingSeqNo != null">feeding_seq_no,</if>
            <if test="remark != null">remark,</if>
            <if test="employeeId != null">employee_id,</if>
            <if test="employeeCode != null">employee_code,</if>
            <if test="latestFlag != null">latest_flag,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="taskId != null">#{taskId},</if>
            <if test="materialId != null">#{materialId},</if>
            <if test="materialCode != null and materialCode != ''">#{materialCode},</if>
            <if test="materialBatchNo != null and materialBatchNo != ''">#{materialBatchNo},</if>
            <if test="taskStatus != null">#{taskStatus},</if>
            <if test="supportMachineId != null">#{supportMachineId},</if>
            <if test="supportMachineCode != null and supportMachineCode != ''">#{supportMachineCode},</if>
            <if test="feedingTime != null">#{feedingTime},</if>
            <if test="feedingWeight != null">#{feedingWeight},</if>
            <if test="feedingSeqNo != null">#{feedingSeqNo},</if>
            <if test="remark != null">#{remark},</if>
            <if test="employeeId != null">#{employeeId},</if>
            <if test="employeeCode != null">#{employeeCode},</if>
            <if test="latestFlag != null">#{latestFlag},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
        </trim>
    </insert>

    <update id="updateFeedingTaskOrderDetail" parameterType="FeedingTaskOrderDetail">
        update feeding_task_order_detail
        <trim prefix="SET" suffixOverrides=",">
            <if test="taskId != null">task_id = #{taskId},</if>
            <if test="materialId != null">material_id = #{materialId},</if>
            <if test="materialCode != null and materialCode != ''">material_code = #{materialCode},</if>
            <if test="materialBatchNo != null and materialBatchNo != ''">material_batch_no = #{materialBatchNo},</if>
            <if test="taskStatus != null">task_status = #{taskStatus},</if>
            <if test="supportMachineId != null">support_machine_id = #{supportMachineId},</if>
            <if test="supportMachineCode != null and supportMachineCode != ''">support_machine_code = #{supportMachineCode},</if>
            <if test="feedingTime != null">feeding_time = #{feedingTime},</if>
            <if test="feedingWeight != null">feeding_weight = #{feedingWeight},</if>
            <if test="feedingSeqNo != null">feeding_seq_no = #{feedingSeqNo},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="employeeId != null">employee_id = #{employeeId},</if>
            <if test="employeeCode != null">employee_code = #{employeeCode},</if>
            <if test="latestFlag != null">latest_flag = #{latestFlag},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where detail_id = #{detailId}
    </update>

    <delete id="deleteFeedingTaskOrderDetailByDetailId" parameterType="Long">
        delete from feeding_task_order_detail where detail_id = #{detailId}
    </delete>

    <delete id="deleteFeedingTaskOrderDetailByDetailIds" parameterType="String">
        delete from feeding_task_order_detail where detail_id in
        <foreach item="detailId" collection="array" open="(" separator="," close=")">
            #{detailId}
        </foreach>
    </delete>

    <select id="getRunningDryingMachines" resultMap="FeedingTaskOrderDetailResult">
        SELECT
            det.*
            FROM
            feeding_task task
            INNER JOIN feeding_task_order_detail det ON task.id = det.task_id
        WHERE
        task.task_status = 'running'
        -- AND det.bind_flag = 1
        <if test="supportMachineCodes != null and supportMachineCodes.size() > 0">
            AND det.support_machine_code IN
            <foreach item="supportMachineCode" collection="supportMachineCodes" open="(" separator="," close=")">
                #{supportMachineCode}
            </foreach>
        </if>
        <if test="supportMachineIds != null and supportMachineIds.size() > 0">
            AND det.support_machine_id IN
            <foreach item="supportMachineId" collection="supportMachineIds" open="(" separator="," close=")">
                #{supportMachineId}
            </foreach>
        </if>
    </select>

    <resultMap type="com.cf.mes.domain.dto.MachineFeedingTaskDetailDto" extends="FeedingTaskOrderDetailResult" id="MachineFeedingTaskDetailDtosResult">
        <result property="minTemperature" column="min_temperature"/>
        <result property="maxTemperature" column="max_temperature"/>
        <result property="minTime" column="min_time"/>
        <result property="maxTime" column="max_time"/>
    </resultMap>
    <select id="getMachineFeedingTaskDetailDtos" resultMap="MachineFeedingTaskDetailDtosResult">
        SELECT
            det.*,
            mds.min_temperature,
            mds.max_temperature,
            mds.min_time,
            mds.max_time
        FROM
        feeding_task task
        INNER JOIN feeding_task_order_detail det ON task.id = det.task_id
        LEFT JOIN material_drying_settings mds ON det.material_id = mds.material_id
        <where>
            <if test="taskId != null">
                AND task.id = #{taskId}
            </if>
            <if test="taskStatusList != null and taskStatusList.size() > 0">
                AND task.task_status IN
                <foreach item="taskStatus" collection="taskStatusList" open="(" separator="," close=")">
                    #{taskStatus}
                </foreach>
            </if>
            <if test="latestFlag != null "> and latest_flag = #{latestFlag}</if>
        </where>
    </select>

    <select id="getMachineFeedingTaskDetailStatDtos" resultType="com.cf.mes.domain.dto.FeedingTaskDetailStatDto">
        SELECT
        det.material_id materialId,
        min(det.feeding_time) firstFeedingTime,
        sum(det.feeding_weight) totalFeedingWeight
        FROM
        feeding_task_order_detail det
        <where>
            <if test="taskId != null">
                AND det.task_id = #{taskId}
            </if>
        </where>
        group by material_id
    </select>

    <!-- task.task_status = 'running' OR (task.task_type = 'prepare' and task.task_status = 'preparing') -->
    <select id="getBindingDryingMachines" resultMap="FeedingTaskOrderDetailResult">
        SELECT
        det.*
        FROM
        feeding_task task
        INNER JOIN feeding_task_order_detail det ON task.id = det.task_id
        WHERE
        task.task_status IN ('running','preparing')
        <if test="supportMachineCodes != null and supportMachineCodes.size() > 0">
            AND det.support_machine_code IN
            <foreach item="supportMachineCode" collection="supportMachineCodes" open="(" separator="," close=")">
                #{supportMachineCode}
            </foreach>
        </if>
        <if test="supportMachineIds != null and supportMachineIds.size() > 0">
            AND det.support_machine_id IN
            <foreach item="supportMachineId" collection="supportMachineIds" open="(" separator="," close=")">
                #{supportMachineId}
            </foreach>
        </if>
    </select>

    <select id="getRunningDryingMachine" resultMap="FeedingTaskOrderDetailResult">
        SELECT
            det.*
        FROM
            feeding_task task
                INNER JOIN feeding_task_order_detail det ON task.id = det.task_id
        WHERE
            task.task_status = 'running'
          AND det.latest_flag = 1
          AND det.task_status = 'running'
          AND support_machine_code = #{machineCode}
    </select>
</mapper>